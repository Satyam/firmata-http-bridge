<html>
  <head>
    <script src="/socket.io/socket.io.min.js"></script>
    <link rel="icon" href="/favicon.svg" />
    <style>
      pre {
        border: silver thin solid;
        margin: 0;
        padding: 0.5em;
      }

      .left {
        float: left;
        width: 45%;
      }
      .right {
        float: right;
        width: 45%;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: thin solid silver;
      }
      td {
        padding-left: 0.5em;
      }

      input,
      select,
      button {
        margin-top: 1em;
      }
      .spaceButtons button {
        margin-left: 0.5em;
        margin-right: 0.5em;
      }
    </style>
  </head>
  <body>
    <a href="/">Home</a>
    <fieldset>
      <legend>pinMode</legend>
      <div class="left">
        <div>
          pin: <input id="pinModePin" type="number" /> (13 for LED_BUILTIN)
        </div>
        <div>
          mode:
          <select id="pinModeMode">
            <option value="0">INPUT</option>
            <option value="1">OUTPUT</option>
            <option value="2">ANALOG</option>
            <option value="3">PWM</option>
            <option value="4">SERVO</option>
            <option value="5">SHIFT</option>
            <option value="6">I2C</option>
            <option value="7">ONEWIRE:</option>
            <option value="8">STEPPER</option>
            <option value="10">SERIAL</option>
            <option value="11">PULLUP</option>
            <option value="127">IGNORE</option>
            <option value="16" selected>UNKOWN</option>
          </select>
        </div>
        <div><button id="pinModeButton">Send</button></div>
      </div>
    </fieldset>
    <h3>
      You must set the pin to the corresponding mode with the command above at
      least once before you do any of the following:
    </h3>
    <fieldset>
      <legend>digitalRead</legend>
      <div class="left">
        <div>pin: <input id="digitalReadPin" type="number" /></div>
        <div class="spaceButtons">
          <button id="digitalReadButton">Read Once</button>
          <button id="digitalReadStartButton">Start Reading</button>
          <button id="digitalReadStopButton">Stop Reading</button>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>digitalWrite</legend>
      <div class="left">
        <div>
          pin: <input id="digitalWritePin" type="number" /> (13 for LED_BUILTIN)
        </div>
        <div>output: <input id="digitalWriteOutput" type="checkbox" /></div>
        <div><button id="digitalWriteButton">Send</button></div>
      </div>
    </fieldset>
    <fieldset>
      <legend>Replies</legend>
      <table>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Payload</th>
          <th>Error</th>
        </tr>
        <tbody id="replies"></tbody>
      </table>
    </fieldset>

    <script type="module">
      import {
        pinModeActionBuilder,
        digitalReadActionBuilder,
        digitalReadStartActionBuilder,
        digitalReadStopActionBuilder,
        digitalWriteActionBuilder,
      } from '/dist/actionBuilders.js';

      const getNumber = (id) => parseInt(document.getElementById(id).value, 10);

      const writeFSA = (where, reply) =>
        (document.getElementById(where).innerHTML = JSON.stringify(
          reply,
          null,
          2
        ));

      const replyEl = document.getElementById('replies');

      const logRequest = (request) => {
        const rowEl = replyEl.insertRow(0);
        rowEl.insertCell(-1).innerHTML = new Date().toLocaleTimeString();
        rowEl.insertCell(-1).innerHTML = request.type;
        rowEl.insertCell(-1).innerHTML = Object.keys(request.payload)
          .map((k) => `${k}=${request.payload[k]}`)
          .join('; ');
      };
      const logReply = (reply) => {
        const fsa = JSON.parse(reply);
        const rowEl = replyEl.insertRow(0);
        rowEl.insertCell(-1).innerHTML = new Date(
          fsa.meta.date
        ).toLocaleTimeString();
        rowEl.insertCell(-1).innerHTML = fsa.type;
        rowEl.insertCell(-1).innerHTML = Object.keys(fsa.payload)
          .map((k) => `${k}=${fsa.payload[k]}`)
          .join('; ');
        rowEl.insertCell(-1).innerHTML = fsa.error
          ? `${fsa.error.code}: ${fsa.error.msg}`
          : '';
      };

      const logOther = (type, payload = '', error = '') => {
        const rowEl = replyEl.insertRow(0);
        rowEl.insertCell(-1).innerHTML = new Date().toLocaleTimeString();
        rowEl.insertCell(-1).innerHTML = type;
        rowEl.insertCell(-1).innerHTML = payload;
        rowEl.insertCell(-1).innerHTML = error;
      };

      const socket = io();

      const emitCommand = (action) => {
        logRequest(action);
        socket.emit('command', JSON.stringify(action));
      };
      socket.on('connect', () => logOther('connected', socket.id));

      socket.on('reply', logReply);

      socket.on('hello', (msg) => logOther('hello', msg));

      socket.on('disconnect', () => logOther('disconnected'));

      document.getElementById('pinModeButton').onclick = (ev) => {
        const pin = getNumber('pinModePin');
        const mode = getNumber('pinModeMode');
        emitCommand(pinModeActionBuilder(pin, mode));
      };

      document.getElementById('digitalReadButton').onclick = (ev) => {
        const pin = getNumber('digitalReadPin');
        emitCommand(digitalReadActionBuilder(pin));
      };

      document.getElementById('digitalReadStartButton').onclick = (ev) => {
        const pin = getNumber('digitalReadPin');
        emitCommand(digitalReadStartActionBuilder(pin));
      };

      document.getElementById('digitalReadStopButton').onclick = (ev) => {
        const pin = getNumber('digitalReadPin');
        emitCommand(digitalReadStopActionBuilder(pin));
      };

      document.getElementById('digitalWriteButton').onclick = (ev) => {
        const pin = getNumber('digitalWritePin');
        const output = document.getElementById('digitalWriteOutput').checked
          ? 1
          : 0;
        emitCommand(digitalWriteActionBuilder(pin, output));
      };
    </script>
  </body>
</html>
